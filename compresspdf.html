<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comprimir PDF</title>

<!-- pdf.js from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs" type="module"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cantarell:wght@400;700&display=swap');

  :root {
    /* Adwaita Light */
    --bg: #fafafa;
    --surface: #ffffff;
    --surface-alt: #f6f5f4;
    --border: #deddda;
    --border-strong: #c0bfbc;
    --text: #3d3846;
    --text-dim: #77767b;
    --accent: #1c71d8;
    --accent-hover: #1a5fb4;
    --accent-bg: #99c1f1;
    --success: #26a269;
    --success-bg: #8ff0a4;
    --warning: #e5a50a;
    --error: #c01c28;
    --error-bg: #f66151;
    --card-shadow: 0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.05);
    --card-shadow-hover: 0 3px 8px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.06);
    --radius: 12px;
    --radius-sm: 8px;
    --transition: 150ms ease;
  }

  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #242424;
      --surface: #303030;
      --surface-alt: #383838;
      --border: #4a4a4a;
      --border-strong: #636363;
      --text: #f6f5f4;
      --text-dim: #9a9996;
      --accent: #62a0ea;
      --accent-hover: #99c1f1;
      --accent-bg: #1a5fb4;
      --success: #57e389;
      --success-bg: #26a269;
      --warning: #f8e45c;
      --error: #f66151;
      --error-bg: #a51d2d;
      --card-shadow: 0 1px 3px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.15);
      --card-shadow-hover: 0 3px 8px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
    }
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Cantarell', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
  }

  .app {
    width: 100%;
    max-width: 640px;
  }

  /* --- Header --- */
  .header {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  .header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }
  .header p {
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  /* --- Drop Zone --- */
  .dropzone {
    border: 2px dashed var(--border-strong);
    border-radius: var(--radius);
    background: var(--surface);
    padding: 2.5rem 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: border-color var(--transition), background var(--transition), box-shadow var(--transition);
    position: relative;
  }
  .dropzone:hover, .dropzone.dragover {
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 6%, var(--surface));
    box-shadow: var(--card-shadow-hover);
  }
  .dropzone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }
  .dropzone-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    opacity: 0.6;
  }
  .dropzone-label {
    font-size: 0.95rem;
    color: var(--text-dim);
  }
  .dropzone-label strong {
    color: var(--accent);
  }

  /* --- Settings --- */
  .settings {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem 1.25rem;
    margin-top: 1rem;
    box-shadow: var(--card-shadow);
  }
  .settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .settings-row + .settings-row {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }
  .settings-label {
    font-size: 0.9rem;
  }
  .settings-label small {
    display: block;
    color: var(--text-dim);
    font-size: 0.8rem;
    margin-top: 2px;
  }
  .settings select, .settings input[type="range"] {
    font-family: inherit;
    font-size: 0.85rem;
    accent-color: var(--accent);
  }
  .settings select {
    background: var(--surface-alt);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.35rem 0.5rem;
  }
  .range-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .range-group input[type="range"] {
    width: 120px;
  }
  .range-value {
    font-size: 0.85rem;
    font-variant-numeric: tabular-nums;
    min-width: 3ch;
    text-align: right;
    color: var(--text-dim);
  }

  /* --- File List --- */
  .file-list {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .file-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 0.85rem 1rem;
    box-shadow: var(--card-shadow);
    transition: box-shadow var(--transition);
    animation: slideIn 200ms ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .file-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }
  .file-name {
    font-size: 0.9rem;
    font-weight: 700;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }
  .file-size {
    font-size: 0.8rem;
    color: var(--text-dim);
    white-space: nowrap;
  }
  .file-status {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .file-status-text {
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  /* Progress bar */
  .progress-bar {
    flex: 1;
    height: 6px;
    background: var(--surface-alt);
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 3px;
    width: 0%;
    transition: width 120ms linear;
  }
  .progress-fill.done {
    background: var(--success);
  }
  .progress-fill.error {
    background: var(--error);
  }

  /* Badges */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
  }
  .badge-success {
    background: color-mix(in srgb, var(--success) 15%, transparent);
    color: var(--success);
  }
  .badge-error {
    background: color-mix(in srgb, var(--error) 15%, transparent);
    color: var(--error);
  }
  .badge-reduction {
    background: color-mix(in srgb, var(--accent) 12%, transparent);
    color: var(--accent);
    font-variant-numeric: tabular-nums;
  }

  .file-result {
    margin-top: 0.4rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  /* Remove button */
  .btn-remove {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
    padding: 0.1rem 0.3rem;
    border-radius: 4px;
    transition: background var(--transition), color var(--transition);
  }
  .btn-remove:hover {
    background: color-mix(in srgb, var(--error) 12%, transparent);
    color: var(--error);
  }
  .btn-defaults {
    font-family: inherit;
    font-size: 0.8rem;
    font-weight: 700;
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-dim);
    padding: 0.3rem 0.7rem;
    cursor: pointer;
    transition: background var(--transition), color var(--transition), border-color var(--transition);
  }
  .btn-defaults:hover {
    background: var(--surface-alt);
    color: var(--text);
    border-color: var(--border-strong);
  }

  /* --- Actions --- */
  .actions {
    margin-top: 1.25rem;
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .btn {
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: 700;
    border: none;
    border-radius: var(--radius-sm);
    padding: 0.65rem 1.5rem;
    cursor: pointer;
    transition: background var(--transition), opacity var(--transition), box-shadow var(--transition);
  }
  .btn:disabled {
    opacity: 0.45;
    cursor: not-allowed;
  }
  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover:not(:disabled) {
    background: var(--accent-hover);
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }
  .btn-secondary {
    background: var(--surface-alt);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover:not(:disabled) {
    background: var(--border);
  }

  /* --- Footer --- */
  .footer {
    margin-top: 2rem;
    text-align: center;
    font-size: 0.78rem;
    color: var(--text-dim);
  }

  /* Utility */
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="app">
  <header class="header">
    <h1>üìÑ Comprimir PDF</h1>
    <p>Compresi√≥n local en tu navegador ‚Äî nada se sube a ning√∫n servidor</p>
  </header>

  <div class="dropzone" id="dropzone">
    <div class="dropzone-icon">üìÅ</div>
    <div class="dropzone-label">
      Arrastr√° archivos PDF ac√° o <strong>hac√© clic para elegir</strong>
    </div>
    <input type="file" id="fileInput" accept=".pdf,application/pdf" multiple>
  </div>

  <div class="settings">
    <div class="settings-row">
      <div class="settings-label">
        Resoluci√≥n (DPI)
        <small>Menor = m√°s compresi√≥n, menos calidad</small>
      </div>
      <div class="range-group">
        <input type="range" id="dpiRange" min="72" max="300" value="200" step="1">
        <span class="range-value" id="dpiValue">200</span>
      </div>
    </div>
    <div class="settings-row">
      <div class="settings-label">
        Calidad JPEG
        <small>0.1 = m√°xima compresi√≥n</small>
      </div>
      <div class="range-group">
        <input type="range" id="qualityRange" min="0.1" max="1.0" value="0.75" step="0.05">
        <span class="range-value" id="qualityValue">0.75</span>
      </div>
    </div>
    <div class="settings-row" style="justify-content: flex-end;">
      <button class="btn-defaults" id="btnDefaults" title="Restablecer valores por defecto">‚Ü∫ Defaults</button>
    </div>
  </div>

  <div class="file-list" id="fileList"></div>

  <div class="actions">
    <button class="btn btn-primary" id="btnCompress" disabled>Comprimir</button>
    <button class="btn btn-secondary hidden" id="btnDownloadAll">Descargar todo (.zip)</button>
    <button class="btn btn-secondary hidden" id="btnClear">Limpiar</button>
  </div>

  <footer class="footer">
    Todo se procesa localmente con <a href="https://mozilla.github.io/pdf.js/" target="_blank">pdf.js</a>
    + <a href="https://pdf-lib.js.org/" target="_blank">pdf-lib</a>.
    C√≥digo equivalente a <code>pdftocairo&nbsp;‚Üí&nbsp;gs</code>.
  </footer>
</div>

<script type="module">
// ‚îÄ‚îÄ Imports ‚îÄ‚îÄ
import * as pdfjsLib from 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.mjs';

// pdf-lib
const PDFLib = await import('https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/+esm');

// JSZip (lazy, for "download all")
let JSZip = null;
async function getJSZip() {
  if (!JSZip) {
    const mod = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
    JSZip = mod.default || mod;
  }
  return JSZip;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const files = []; // { id, file, status, progress, resultBlob, resultSize, error }
let idCounter = 0;

// ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
const dropzone     = document.getElementById('dropzone');
const fileInput    = document.getElementById('fileInput');
const fileListEl   = document.getElementById('fileList');
const btnCompress  = document.getElementById('btnCompress');
const btnDownloadAll = document.getElementById('btnDownloadAll');
const btnClear     = document.getElementById('btnClear');
const btnDefaults  = document.getElementById('btnDefaults');
const dpiRange     = document.getElementById('dpiRange');
const dpiValue     = document.getElementById('dpiValue');
const qualityRange = document.getElementById('qualityRange');
const qualityValue = document.getElementById('qualityValue');

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ
dpiRange.addEventListener('input', () => dpiValue.textContent = dpiRange.value);
qualityRange.addEventListener('input', () => qualityValue.textContent = parseFloat(qualityRange.value).toFixed(2));

// Defaults: 200 DPI, 0.75 quality (matches the bash script)
const DEFAULTS = { dpi: 200, quality: 0.75 };
btnDefaults.addEventListener('click', () => {
  dpiRange.value = DEFAULTS.dpi;
  dpiValue.textContent = DEFAULTS.dpi;
  qualityRange.value = DEFAULTS.quality;
  qualityValue.textContent = DEFAULTS.quality.toFixed(2);
});

// ‚îÄ‚îÄ File Input ‚îÄ‚îÄ
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', () => { addFiles(fileInput.files); fileInput.value = ''; });

function addFiles(fileListInput) {
  for (const f of fileListInput) {
    if (f.type !== 'application/pdf' && !f.name.toLowerCase().endsWith('.pdf')) continue;
    files.push({ id: ++idCounter, file: f, status: 'pending', progress: 0, resultBlob: null, resultSize: 0, error: null });
  }
  render();
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function render() {
  btnCompress.disabled = files.length === 0 || files.some(f => f.status === 'processing');

  const anyDone = files.some(f => f.status === 'done');
  const allDone = files.length > 0 && files.every(f => f.status === 'done' || f.status === 'error');
  btnDownloadAll.classList.toggle('hidden', !anyDone || files.filter(f => f.status === 'done').length < 2);
  btnClear.classList.toggle('hidden', files.length === 0);

  fileListEl.innerHTML = '';
  for (const f of files) {
    const card = document.createElement('div');
    card.className = 'file-card';

    let statusHTML = '';
    if (f.status === 'pending') {
      statusHTML = `<span class="file-status-text">En espera</span>`;
    } else if (f.status === 'processing') {
      statusHTML = `
        <div class="progress-bar"><div class="progress-fill" style="width:${f.progress}%"></div></div>
        <span class="file-status-text">${f.progress}%</span>`;
    } else if (f.status === 'done') {
      const reduction = ((1 - f.resultSize / f.file.size) * 100).toFixed(1);
      statusHTML = `
        <span class="badge badge-success">‚úì Listo</span>
        <span class="badge badge-reduction">‚àí${reduction}%</span>
        <span class="file-size">${formatSize(f.resultSize)}</span>`;
    } else if (f.status === 'error') {
      statusHTML = `<span class="badge badge-error">‚úó Error</span> <span class="file-status-text">${f.error}</span>`;
    }

    const canRemove = f.status !== 'processing';
    const canDownload = f.status === 'done';

    card.innerHTML = `
      <div class="file-card-header">
        <span class="file-name" title="${esc(f.file.name)}">${esc(f.file.name)}</span>
        <span class="file-size">${formatSize(f.file.size)}</span>
        ${canDownload ? `<button class="btn-remove" data-action="download" data-id="${f.id}" title="Descargar">‚¨á</button>` : ''}
        ${canRemove ? `<button class="btn-remove" data-action="remove" data-id="${f.id}" title="Quitar">‚úï</button>` : ''}
      </div>
      <div class="file-status">${statusHTML}</div>`;

    fileListEl.appendChild(card);
  }
}

fileListEl.addEventListener('click', e => {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const id = parseInt(btn.dataset.id);
  if (btn.dataset.action === 'remove') {
    const idx = files.findIndex(f => f.id === id);
    if (idx !== -1) files.splice(idx, 1);
    render();
  } else if (btn.dataset.action === 'download') {
    const f = files.find(f => f.id === id);
    if (f?.resultBlob) downloadBlob(f.resultBlob, f.file.name.replace(/\.pdf$/i, '_compressed.pdf'));
  }
});

btnClear.addEventListener('click', () => { files.length = 0; render(); });

// ‚îÄ‚îÄ Compress ‚îÄ‚îÄ
btnCompress.addEventListener('click', async () => {
  const dpi = parseInt(dpiRange.value);
  const quality = parseFloat(qualityRange.value);

  // Reset pending/error files
  for (const f of files) {
    if (f.status !== 'done') {
      f.status = 'processing';
      f.progress = 0;
      f.error = null;
      f.resultBlob = null;
    }
  }
  render();

  for (const f of files) {
    if (f.status !== 'processing') continue;
    try {
      f.resultBlob = await compressPDF(f.file, dpi, quality, (p) => {
        f.progress = p;
        render();
      });
      f.resultSize = f.resultBlob.size;
      f.status = 'done';
    } catch (err) {
      console.error(err);
      f.status = 'error';
      f.error = err.message || 'Error desconocido';
    }
    render();
  }
});

// ‚îÄ‚îÄ Download All (zip) ‚îÄ‚îÄ
btnDownloadAll.addEventListener('click', async () => {
  const ZipClass = await getJSZip();
  const zip = new ZipClass();
  for (const f of files) {
    if (f.status === 'done' && f.resultBlob) {
      zip.file(f.file.name.replace(/\.pdf$/i, '_compressed.pdf'), f.resultBlob);
    }
  }
  const blob = await zip.generateAsync({ type: 'blob' });
  downloadBlob(blob, 'pdfs_comprimidos.zip');
});

// ‚îÄ‚îÄ Core: Compress a single PDF ‚îÄ‚îÄ
async function compressPDF(file, dpi, jpegQuality, onProgress) {
  const arrayBuf = await file.arrayBuffer();

  // 1) Render pages with pdf.js (equivalent to pdftocairo)
  const pdfDoc = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuf) }).promise;
  const numPages = pdfDoc.numPages;
  const pageImages = []; // { bytes: Uint8Array, width, height }

  for (let i = 1; i <= numPages; i++) {
    const page = await pdfDoc.getPage(i);
    const viewport = page.getViewport({ scale: dpi / 72 });

    const canvas = document.createElement('canvas');
    canvas.width  = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);
    const ctx = canvas.getContext('2d');

    // White background (like pdftocairo)
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    await page.render({ canvasContext: ctx, viewport }).promise;

    // Export as JPEG (equivalent to gs compression)
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', jpegQuality));
    const bytes = new Uint8Array(await blob.arrayBuffer());

    pageImages.push({ bytes, width: canvas.width, height: canvas.height });

    onProgress(Math.round((i / numPages) * 80));

    // Free memory
    canvas.width = 0;
    canvas.height = 0;
  }

  // 2) Rebuild PDF with pdf-lib (equivalent to gs output)
  const newPdf = await PDFLib.PDFDocument.create();

  for (let i = 0; i < pageImages.length; i++) {
    const { bytes, width, height } = pageImages[i];
    const jpgImage = await newPdf.embedJpg(bytes);

    // Page size matches original pixel dimensions at target DPI
    const pageWidth  = (width / dpi) * 72;
    const pageHeight = (height / dpi) * 72;

    const page = newPdf.addPage([pageWidth, pageHeight]);
    page.drawImage(jpgImage, { x: 0, y: 0, width: pageWidth, height: pageHeight });

    onProgress(80 + Math.round(((i + 1) / pageImages.length) * 20));
  }

  const pdfBytes = await newPdf.save();
  return new Blob([pdfBytes], { type: 'application/pdf' });
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 5000);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
render();
</script>

</body>
</html>
